<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tug of Word</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body {
            font-family: 'Press Start 2P', monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
            color: #333;
        }
        #game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
        }
        #grid-container {
            display: grid;
            grid-template-columns: repeat(21, 30px); /* 21 columns, 30px width */
            grid-template-rows: repeat(15, 30px);    /* 15 rows, 30px height */
            border: 2px solid #666;
            background-color: #ddd;
            padding: 5px;
            margin-bottom: 20px;
            position: relative; /* Needed for absolute positioning of input */
        }
        .cell {
            width: 30px;
            height: 30px;
            border: 1px solid #999;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            cursor: pointer;
            user-select: none;
            background-color: #fff;
            position: relative; /* For relative positioning of the input field */
            overflow: hidden;  /* to hide overflowing input characters */
        }
        .cell.starting-letter {
            background-color: #ffd700; /* Gold */
            color: #000;
        }
        .cell.player1 {
            background-color: #87cefa; /* Light Blue */
            color: #000;
        }
        .cell.player2 {
            background-color: #dda0dd; /* Light Purple */
            color: #000;
        }
        .cell.selected {
            background-color: #ffff00; /* Yellow */
            color: #000;
        }
        .input-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }

        #word-input {
            padding: 10px;
            font-size: 16px;
            margin-right: 10px;
            font-family: 'Press Start 2P', monospace;
            width: 200px;
            display: none; /* Hide the text input field */
        }
        #submit-word {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Press Start 2P', monospace;
        }
        #submit-word:hover {
            background-color: #367c39;
        }
        #message-box {
            margin-top: 10px;
            font-size: 16px;
            color: #333;
            min-height: 2em;
            text-align: center;
        }
        .game-controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            align-items: center; /* Vertically align items */
        }

        .control-button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #008CBA;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Press Start 2P', monospace;
        }

        .control-button:hover {
            background-color: #005f6b;
        }

       .player-weight {
            width: 40px; /* Initial width */
            height: 10px;
            background-color: #888; /* Grey default */
            margin-top: 10px;
            border-radius: 5px;
            transition: width 0.5s ease; /* Smooth transition */
            text-align: center;
            line-height: 10px;
            font-size: 0.7em;
            color: white;
        }

        #player1-weight {
            background-color: #87cefa; /* Light Blue */
        }

        #player2-weight {
          background-color: #dda0dd; /* Light Purple */
        }

        /* Input field for direct typing */
        .cell input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            text-align: center;
            font-size: 16px;
            font-family: 'Press Start 2P', monospace;
            padding: 0;
            background-color: transparent;
            z-index: 1;
            opacity: 0; /* Make it invisible initially */
            cursor: pointer; /* Make it obvious that the cell is clickable */
            -webkit-appearance: none;  /* removes default input styling */
            appearance: none;
            box-sizing: border-box; /* Ensure padding doesn't affect dimensions */
        }

        .cell input:focus {
            outline: none; /* Remove the default outline */
            opacity: 1;  /* Make it visible when focused */
            background-color: rgba(255, 255, 0, 0.2); /* হালকা হলুদ রঙ */
        }

    </style>
</head>
<body>
    <div id="game-container">
        <div id="grid-container"></div>
        <div class="input-container">
            <input type="text" id="word-input" placeholder="Enter your word">
            <button id="submit-word">Submit Word</button>
        </div>
        <div id="message-box"></div>
        <div class="game-controls">
            <button id="reset-game" class="control-button">Reset Game</button>
            <div style="display: flex; flex-direction: column; align-items: center;">
                Player 1 Weight:
                <div id="player1-weight" class="player-weight">0%</div>
            </div>
            <div style="display: flex; flex-direction: column; align-items: center;">
                Player 2 Weight:
                <div id="player2-weight" class="player-weight">0%</div>
            </div>
        </div>
    </div>

    <script type="text/babel">

        const COLS = 21;
        const ROWS = 15;
        let grid = [];
        let currentPlayer = 1;  // 1 for Player 1, 2 for Player 2
        let startingLetter = '';
        let gameOver = false;
        let wordsPlayed = []; // Array to store words and their positions
        let player1Weight = 0;
        let player2Weight = 0;
        let selectedRow = -1;
        let selectedCol = -1;
        let selectedLetter = '';
        let currentInputWord = ''; // To store the word being built
        let activeInputCell = null;

        const gridContainer = document.getElementById('grid-container');
        const wordInput = document.getElementById('word-input');
        const submitWordButton = document.getElementById('submit-word');
        const messageBox = document.getElementById('message-box');
        const resetButton = document.getElementById('reset-game');
        const player1WeightDisplay = document.getElementById('player1-weight');
        const player2WeightDisplay = document.getElementById('player2-weight');


        function createGrid() {
            grid = [];
            gridContainer.innerHTML = ''; // Clear any existing grid
            for (let i = 0; i < ROWS; i++) {
                grid[i] = [];
                for (let j = 0; j < COLS; j++) {
                    const cell = document.createElement('div');
                    cell.classList.add('cell');
                    cell.id = `cell-${i}-${j}`;
                    const input = document.createElement('input');  // Create input element
                    input.type = 'text';
                    input.maxLength = '1';  // Restrict input to a single character
                    input.addEventListener('input', handleCellInput); // Attach input event
                    input.addEventListener('keydown', handleCellKeyDown);
                    cell.appendChild(input); // Add the input to the cell
                    gridContainer.appendChild(cell);
                    grid[i][j] = ''; // Initialize cell content
                }
            }
        }

        function initializeGame() {
            createGrid();
            startingLetter = String.fromCharCode(65 + Math.floor(Math.random() * 26)); // A-Z
            const startCol = 10; // Column 11 (0-indexed)
            grid[0][startCol] = startingLetter;
            const startCell = document.getElementById(`cell-0-${startCol}`);
            startCell.textContent = startingLetter;
            startCell.classList.add('starting-letter');
            currentPlayer = 1;
            gameOver = false;
            wordsPlayed = [];
            player1Weight = 0;
            player2Weight = 0;
            selectedRow = -1;
            selectedCol = -1;
            selectedLetter = '';
            currentInputWord = '';
            activeInputCell = null;
            updateWeightDisplay();
            messageBox.textContent = `Player 1: Enter a word using '${startingLetter}'`;
            wordInput.value = '';
            wordInput.disabled = true; // Keep the text input disabled
            submitWordButton.disabled = true; // Disable submit button initially
        }


        function getCellElement(row, col) {
            return document.getElementById(`cell-${row}-${col}`);
        }

        function updateGridDisplay() {
            for (let i = 0; i < ROWS; i++) {
                for (let j = 0; j < COLS; j++) {
                    const cell = getCellElement(i, j);
                    const input = cell.querySelector('input');
                    cell.textContent = grid[i][j]; // Display the letter in the cell
                    cell.className = 'cell'; // Reset classes
                    if (grid[i][j]) {
                        if (wordsPlayed.some(wordObj =>
                            wordObj.word.split('').some((letter, index) =>
                                wordObj.row === i && wordObj.col + index === j && wordObj.orientation === 'horizontal' ||
                                wordObj.row + index === i && wordObj.col === j && wordObj.orientation === 'vertical'
                            )
                        )) {
                            cell.classList.add(currentPlayer === 1 ? 'player1' : 'player2');
                        }
                    }
                    if (i === 0 && j === 10) {
                        cell.classList.add('starting-letter');
                    }
                    if (selectedRow === i && selectedCol === j) {
                        cell.classList.add('selected');
                    }
                    input.value = grid[i][j]; // Keep input value synced with grid
                    input.style.opacity = grid[i][j] ? 0 : 1; // Show input only when cell is empty
                }
            }
        }

        function isValidWord(word) {
            // Basic validation: Check if word is not empty.  A real game would check against a dictionary.
            return word.length > 1;
        }

        function canPlaceWord(word, row, col) {
            if (!isValidWord(word)) {
                return false;
            }

            if (col + word.length > COLS) {
                return false; // Word exceeds grid boundary
            }

            if (wordsPlayed.length === 0 && row === 0) {
                // First word placement by player 1
                const startCol = 10;
                const wordCol = word.indexOf(startingLetter);
                if (wordCol === -1) {
                    return false; // Word must contain starting letter
                }
                if (col !== startCol - wordCol) {
                    return false;
                }
                return true;
            }

            // Check for overlap and anchor letter
            let foundAnchor = false;
            for (let i = 0; i < word.length; i++) {
                const checkRow = row;
                const checkCol = col + i;

                if (checkRow < 0 || checkRow >= ROWS || checkCol < 0 || checkCol >= COLS) {
                    return false; // Out of bounds
                }

                if (grid[checkRow][checkCol] && grid[checkRow][checkCol] !== word[i]) {
                    return false; // Overlapping different letter
                }
                if (checkRow === selectedRow && checkCol === selectedCol) {
                    foundAnchor = true;
                }
            }
            return foundAnchor;
        }

        function placeWord(word, row, col) {
             if (!isValidWord(word)) {
                messageBox.textContent = "Invalid word!";
                return false;
            }

            const previousWords = wordsPlayed;
            if (!canPlaceWord(word, row, col)) {
                messageBox.textContent = "Cannot place word there!";
                return false;
            }

            for (let i = 0; i < word.length; i++) {
                const placeRow =  row ;
                const placeCol =  col + i;
                grid[placeRow][placeCol] = word[i];
            }

            wordsPlayed.push({ word, row, col, orientation: 'horizontal' }); // Store the word placement
            updateGridDisplay();
            return true;
        }

        function determinePlayableLetters(row) {
            const letters = [];
            for (let j = 0; j < COLS; j++) {
                if (grid[row][j]) {
                    letters.push({ letter: grid[row][j], col: j });
                }
            }
            return letters;
        }



        function handlePlayerTurn() {
            if (gameOver) return;

            const word = currentInputWord.toUpperCase();
            let row, col;

             if (currentPlayer === 1) {
                if (wordsPlayed.length === 0) {
                    // First word of the game
                    const startCol = 10;
                    const wordCol = word.indexOf(startingLetter);
                    if (wordCol === -1) {
                        messageBox.textContent = `Word must contain the starting letter '${startingLetter}'`;
                        return;
                    }
                    row = 0;
                    col = startCol - wordCol;
                    if (placeWord(word, row, col)) {
                        currentPlayer = 2;
                        messageBox.textContent = "Player 2's turn: Select a letter to play off of.";
                    }
                } else {
                    // Player 1's subsequent turns
                    if (selectedRow === -1 || selectedCol === -1) {
                        messageBox.textContent = "Select a letter to play off of!";
                        return;
                    }
                    const previousWord = wordsPlayed[wordsPlayed.length - 1];
                    row = previousWord.row + 1;
                    col = selectedCol - word.indexOf(selectedLetter);
                    if (placeWord(word, row, col)) {
                        currentPlayer = 2;
                        messageBox.textContent = "Player 2's turn: Select a letter to play off of.";
                    }
                }
            } else {
                if (wordsPlayed.length === 1) {
                    // Player 2's first turn.  Must play in column 2.
                    const wordCol = 1; // Fixed column for Player 2's first word
                    const letterIndex = word.indexOf(grid[0][wordCol]);
                    if (letterIndex === -1) {
                        messageBox.textContent = `Word must contain the letter '${grid[0][wordCol]}' from column 2.`;
                        return;
                    }
                    row = letterIndex;
                    col = wordCol;
                    if (placeWord(word, row, col)) {
                        currentPlayer = 1;
                        messageBox.textContent = "Player 1's turn: Select a letter to play off of.";
                    }
                } else {
                    // Player 2's subsequent turns
                    if (selectedRow === -1 || selectedCol === -1) {
                        messageBox.textContent = "Select a letter to play off of!";
                        return;
                    }
                    const previousWord = wordsPlayed[wordsPlayed.length - 1];
                    row = previousWord.row + 1;
                    col = selectedCol - word.indexOf(selectedLetter);

                    if (placeWord(word, row, col)) {
                        currentPlayer = 1;
                        messageBox.textContent = "Player 1's turn: Select a letter to play off of.";
                    }
                }
            }
            if (!gameOver) {
                calculateWeights();
                updateWeightDisplay();
            }
            selectedRow = -1;
            selectedCol = -1;
            selectedLetter = '';
            currentInputWord = '';
            activeInputCell = null;
            wordInput.value = '';
            wordInput.disabled = true;
            submitWordButton.disabled = true;
        }

        function calculateWeights() {
            player1Weight = 0;
            player2Weight = 0;
            let totalLetters = 0;

            for (let r = 0; r < ROWS; r++) {
                for (let c = 0; c < COLS; c++) {
                    if (grid[r][c] !== '') {
                        totalLetters++;
                        if (c < 10) { // Columns 0-9: Player 1's side
                            player1Weight++;
                        } else if (c > 10) { // Columns 11-20: Player 2's side
                            player2Weight++;
                        }
                    }
                }
            }
            //handle edge case of 0 letters.
            if (totalLetters === 0){
                player1Weight = 0;
                player2Weight = 0;
            }
            else{
                player1Weight = (player1Weight / totalLetters) * 100;
                player2Weight = (player2Weight / totalLetters) * 100;
            }


        }

        function updateWeightDisplay() {
            player1WeightDisplay.style.width = `${player1Weight}%`;
            player1WeightDisplay.textContent = `${player1Weight.toFixed(0)}%`;
            player2WeightDisplay.style.width = `${player2Weight}%`;
            player2WeightDisplay.textContent = `${player2Weight.toFixed(0)}%`;
        }

        function resetGame() {
            initializeGame();
        }

        function handleCellClick(event) {
            const cell = event.target.parentElement; // Get the parent .cell element
            const parts = cell.id.split('-');
            const row = parseInt(parts[1]);
            const col = parseInt(parts[2]);

            // Only allow selection of letters from previous words
            let isPlayable = false;
            if (wordsPlayed.length > 0) {
                const prevWord = wordsPlayed[wordsPlayed.length - 1];
                const nextRow = prevWord.row + 1;
                if (row === nextRow) { // Only allow selection in the row below.
                    for (let i = 0; i < prevWord.word.length; i++) {
                        const checkRow = prevWord.orientation === 'vertical' ? prevWord.row + i : prevWord.row;
                        const checkCol = prevWord.orientation === 'horizontal' ? prevWord.col + i : prevWord.col;
                        if (checkRow === row - 1 && checkCol === col && grid[row - 1][col] !== '') {
                            isPlayable = true;
                            break;
                        }
                    }
                }
            } else if (row === 0 && col === 10) {
                isPlayable = true;
            }

            if (isPlayable) {
                selectedRow = row;
                selectedCol = col;
                selectedLetter = grid[row][col];
                updateGridDisplay(); // Re-render to show selection
                messageBox.textContent = `Selected letter: ${selectedLetter}. Enter your word:`;
                wordInput.disabled = false; // Enable the input field
                submitWordButton.disabled = false;
                wordInput.focus();

                //set focus to the cell below
                const nextInput = getCellElement(row,col).querySelector('input');
                nextInput.focus();
                activeInputCell = {row, col};
                currentInputWord = selectedLetter;

            } else {
                messageBox.textContent = "Invalid cell selected. Please select a letter from the previous word in the row above.";
            }
        }

        function handleCellInput(event) {
            const input = event.target;
            let value = input.value.toUpperCase();
            input.value = value; // Ensure the value is uppercase
             const cell = event.target.parentElement;
            const parts = cell.id.split('-');
            const row = parseInt(parts[1]);
            const col = parseInt(parts[2]);

            if (value) {
                grid[row][col] = value;
                currentInputWord += value;
                 // Move focus to the next cell to the right
                const nextCol = col + 1;
                if (nextCol < COLS) {
                    const nextCellInput = getCellElement(row, nextCol).querySelector('input');
                    if (nextCellInput) {
                        nextCellInput.focus();
                        activeInputCell = {row, col: nextCol};
                    }
                }
            }
            else{
                 grid[row][col] = '';
                 currentInputWord = currentInputWord.slice(0, -1);
            }
            updateGridDisplay();

        }

        function handleCellKeyDown(event) {
            if (event.key === 'Enter') {
                handlePlayerTurn();
            }
            else if (event.key === 'Backspace'){
                const cell = event.target.parentElement;
                const parts = cell.id.split('-');
                const row = parseInt(parts[1]);
                const col = parseInt(parts[2]);
                grid[row][col] = '';
                currentInputWord = currentInputWord.slice(0, -1);
                updateGridDisplay();
                const prevCol = col - 1;
                if(prevCol >= 0){
                     const prevCellInput = getCellElement(row, prevCol).querySelector('input');
                    if (prevCellInput) {
                        prevCellInput.focus();
                        activeInputCell = {row, col: prevCol};
                    }
                }

            }
        }

        submitWordButton.addEventListener('click', handlePlayerTurn);
        resetButton.addEventListener('click', resetGame);

        initializeGame(); // Start the game when the page loads

    </script>
</body>
</html>
